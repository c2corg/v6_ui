<%!
from c2corg_common.attributes import default_langs, activities, condition_ratings, \
    hut_status, lift_status, frequentation_types, avalanche_signs, \
    route_duration_types, access_conditions, glacier_ratings, \
    via_ferrata_ratings, mtb_up_ratings, mtb_down_ratings, ski_ratings, \
    global_ratings, engagement_ratings, ice_ratings, equipment_ratings, \
    hiking_ratings, snowshoe_ratings, climbing_ratings
%>

<%inherit file="../base.html"/>

<%
updating_doc = outing_id and outing_lang
%>

<%namespace file="../helpers/common.html" import="show_title"/>
<%namespace file="../helpers/edit.html" import="show_editing_associated_waypoints,
    show_editing_associated_routes,show_preview_container, show_save_confirmation_modal,
    show_editing_buttons, show_protected_warning"/>
<%namespace file="../helpers/cotometer.html" import="show_cotometer_dialog"/>

<%block name="pagetitle"><title ng-init="id=${outing_id if outing_id else 0}" ng-bind="id ? mainCtrl.page_title('Editing an outing') : mainCtrl.page_title('Creating an outing')">${show_title('Create/edit outing')}</title></%block>
<%block name="metarobots"><meta name="robots" content="noindex,nofollow"></%block>
<div class="viewdoc" ng-cloak>
<section class="create-edit-document">

  <h1 ng-cloak ng-init="id=${outing_id if outing_id else 0}"
      ng-bind="id ? ('Editing an outing' | translate) : ('Creating an outing' | translate)"
      class="text-center"></h1>

  <form c2c-loading c2c-document-editing="outings" c2c-document-editing-model="outing"
    c2c-document-editing-controller-name="appOutingEditingController"
  % if updating_doc:
    c2c-document-editing-id="${outing_id}" c2c-document-editing-lang="${outing_lang}"
  % endif
    name="editForm" novalidate class="document-editing">

    <c2c-progress-bar>
      ## It won't work with ng-init
      <span class="ng-hide">{{progressBarCtrl.maxSteps = 3}}</span>

      ## PROGRESS BAR
      <ul class="progress-bar-edit">
        <li class="nav-step-1" ng-click="progressBarCtrl.step(1, 'outing',  'backwards')" ng-class="{'nav-step-selected': progressBarCtrl.currentStep == 1 }"><span class="nav-text"><span translate>track</span></span><span class="bullet-container"><span class="bullet"></span></span></li>
        <li class="nav-step-2" ng-click="progressBarCtrl.step(2, 'outing', progressBarCtrl.previousStep >= 2 ? 'backwards' : 'forwards')"><span class="nav-text"><span translate>weather</span> & <span translate>conditions</span></span><span class="bullet-container"><span class="bullet"></span></span></li>
        <li class="nav-step-3" ng-click="progressBarCtrl.step(3, 'outing', progressBarCtrl.previousStep >= 3 ? 'backwards' : 'forwards')"><span class="nav-text"><span translate>personal informations</span></span><span class="bullet-container"><span class="bullet"></span></span></li>
      </ul>

      ## NAV BUTTONS
      <div class="nav-buttons">
        <button class="btn btn-primary prev" type="button" ng-if="progressBarCtrl.previousStep !== 0" ng-click="progressBarCtrl.step(progressBarCtrl.previousStep, 'outing', 'backwards')"><span class="glyphicon glyphicon-triangle-left"></span></button>
        <button class="btn btn-primary next" type="button" ng-if="progressBarCtrl.nextStep <= progressBarCtrl.maxSteps" ng-click="progressBarCtrl.step(progressBarCtrl.nextStep, 'outing', 'forwards')"><span class="glyphicon glyphicon-triangle-right"></span></button>
      </div>
    </c2c-progress-bar>

    ${show_protected_warning('outing')}

    <section class="editing outing">
      <div class="step step-1">

        <section class="section title">
          <h2 class="heading show-phone" translate>general informations</h2>
          <div class="content collapse in" id="title-edit">

            ## DATE START
            <div class="date form-group" ng-init="openDateStart = false">
              <label><span translate>date_start</span> *</label>
              <div class="input-group" ng-model="outing.date_start" datepicker-options="{maxDate : editCtrl.dateMaxStart}"
                   uib-datepicker-popup="dd MM yyyy" is-open="openDateStart" ng-change="editCtrl.dateMinEnd = outing.date_start">
                <input type="text" disabled class="form-control" value="{{outing.date_start | amDateFormat:'Do MMMM YYYY' }}" required/>
                <span class="input-group-btn">
                  <button type="button" class="btn btn-default" ng-click="openDateStart = true"><span class="glyphicon glyphicon-calendar"></span></button>
                </span>
              </div>
            </div>

            ## DATE END
            <div class="date form-group flex flexend-align" ng-init="openDateEnd = false">
              <div ng-show="editCtrl.differentDates">
                <label><span translate>date_end </span></label>
                <div class="input-group" ng-model="outing.date_end" datepicker-options="{maxDate : editCtrl.dateMaxEnd, minDate: editCtrl.dateMinEnd}"
                     uib-datepicker-popup="dd MM yyyy" is-open="openDateEnd" ng-change="editCtrl.dateMaxStart = outing.date_end">
                  <input disabled type="text" class="form-control" value="{{outing.date_end | amDateFormat:'Do MMMM YYYY' }}"/>
                  <span class="input-group-btn">
                    <button type="button" class="btn btn-default" ng-click="openDateEnd = true"><span class="glyphicon glyphicon-calendar"></span></button>
                  </span>
                </div>
                <span class="glyphicon glyphicon-remove form-control-feedback pointer" ng-click="editCtrl.differentDates = false; outing.date_end = undefined; editCtrl.dateMaxStart = editCtrl.today;"></span>
              </div>
              <div ng-click="editCtrl.differentDates = true" ng-show="!editCtrl.differentDates" class="flex flexend-align">
                <button class="btn orange-btn" type="button" translate>Several days?</button>
              </div>
            </div>

            ## ACTIVITIES
            <div class="form-group full" id="outing-activities" ng-init="activities = ${activities}">
              <label c2c-context-help context-help-title="{{'activities' | translate}}" context-help-content-url="/static/partials/contexthelp/activities.html"><span translate>activities</span> *</label>
              <div class="route-activities">
                <div ng-repeat="activity in activities" class="activity">
                  <div>
                    <div class="icon-{{activity}}" class="icon-" ng-click="editCtrl.pushToArray(outing, 'activities', activity, $event)"
                         ng-class="{'activity-selected' : outing.activities.indexOf(activity) > -1}">
                    </div>
                    <p>{{activity | translate}}</p>
                  </div>
                </div>
              </div>
            </div>

            ## MAP
            <div class="full form-group">
              <label translate>Track</label>
              <div class="track">
                <app-gpx-upload></app-gpx-upload>
                <div class="track-tip" translate>You may also drag, draw or edit the track on the map.</div>
              </div>
              <app-map app-map-edit="true" app-map-show-recenter-tools="true" app-map-draw-type="LineString" class="map-edit"></app-map>
            </div>

            ## ROUTE TAKEN
            <div class="full form-group">
              <label c2c-context-help context-help-title="{{'Taken routes' | translate}}" context-help-content-url="/static/partials/contexthelp/associate.html"><span translate>Taken routes</span> *</label>
              <h5 translate ng-show="outing.associations.routes.length == 0">Choose at least one route taken during the outing.</h5>
              <app-simple-search parent-id="outing.document_id"
                app-select="editCtrl.documentService.pushToAssociations(doc, 'routes', editCtrl.handleAssociation)" dataset="r"></app-simple-search>
            </div>

            <div class="row">
              <div class="col-xs-12">
                <span class="lead">
                  <section>
                    ${show_editing_associated_routes('outing', True)}
                  </section>
                </span>
              </div>
            </div>
            
            ## ROUTE DESCRIPTION
            <div class="full form-group">
              <label translate>route_description</label>
              <textarea app-markdown-editor class="form-control" ng-model="outing.locales[0].route_description" placeholder="{{'describe route_conditions' | translate}}"></textarea>
            </div>

            ## TIMING
            <div class="full form-group">
              <label translate>timing</label>
              <textarea app-markdown-editor class="form-control" ng-model="outing.locales[0]['timing']" placeholder="{{'describe timing' | translate}}"></textarea>
            </div>

            ## PARTIAL TRIP
            <div class="form-group half">
              <label translate>partial_trip</label>
              <input type="checkbox" ng-model="outing.partial_trip">
              <span ng-click="editCtrl.pushToArray(outing, 'partial_trip', !outing.partial_trip, $event)"></span>
            </div>

            ## LENGTH TOTAL
            <div id="length_total-group" class="half form-group"
                 ng-class="{ 'has-feedback': editForm.length_total.$touched,
                             'has-error': editForm.length_total.$touched && editForm.length_total.$invalid,
                             'has-success': outing.length_total }">
              <label ng-class="{ 'control-label': editForm.length_total.$touched && editForm.length_total.$invalid }" translate>length_total</label>
              <div class="input-group">
                <input type="number" min="0" minlength="1" step="any" name="length_total" ng-model="outing.length_total" class="form-control" />
                <span class="input-group-addon">km</span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="editForm.length_total.$valid && outing.length_total"></span>
              <span class="glyphicon glyphicon-warning-sign form-control-feedback" ng-show="editForm.length_total.$touched && editForm.length_total.$invalid"></span>
              <div class="help-block" ng-messages="editForm.length_total.$error" ng-if="editForm.length_total.$touched && editForm.length_total.$invalid">
                <p ng-message="number" translate>This field must be a number.</p>
              </div>
            </div>

            ## ELEVATION MIN
            <div id="elevation_min-group" class="half remain form-group"
                 ng-class="{ 'has-feedback': editForm.elevation_min.$touched,
                             'has-error': editForm.elevation_min.$touched && editForm.elevation_min.$invalid,
                             'has-success': outing.elevation_min }">
              <label ng-class="{ 'control-label': editForm.elevation_min.$touched && editForm.elevation_min.$invalid }" translate>elevation_min</label>
              <div class="input-group">
                <input type="number" min="0" max="9999" minlength="1" name="elevation_min" ng-model="outing.elevation_min" class="form-control" />
                <span class="input-group-addon">m</span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="editForm.elevation_min.$valid && outing.elevation_min"></span>
              <span class="glyphicon glyphicon-warning-sign form-control-feedback" ng-show="editForm.elevation_min.$touched && editForm.elevation_min.$invalid"></span>
              <div class="help-block" ng-messages="editForm.elevation_min.$error" ng-if="editForm.elevation_min.$touched && editForm.elevation_min.$invalid">
                <p ng-message="max" translate>This field must be lower than 9999 m.</p>
                <p ng-message="number" translate>This field must be a number.</p>
              </div>
            </div>

            ## ELEVATION MAX
            <div id="elevation_max-group" class="half remain form-group"
                 ng-class="{ 'has-feedback': editForm.elevation_max.$touched,
                             'has-error': editForm.elevation_max.$touched && editForm.elevation_max.$invalid,
                             'has-success': outing.elevation_max }">
              <label ng-class="{ 'control-label': editForm.elevation_max.$touched && editForm.elevation_max.$invalid }" translate>elevation_max</label>
              <div class="input-group">
                <input type="number" min="0" max="9999" minlength="1" name="elevation_max" ng-model="outing.elevation_max" class="form-control" />
                <span class="input-group-addon">m</span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="editForm.elevation_max.$valid && outing.elevation_max"></span>
              <span class="glyphicon glyphicon-warning-sign form-control-feedback" ng-show="editForm.elevation_max.$touched && editForm.elevation_max.$invalid"></span>
              <div class="help-block" ng-messages="editForm.elevation_max.$error" ng-if="editForm.elevation_max.$touched && editForm.elevation_max.$invalid">
                <p ng-message="max" translate>This field must be lower than 9999 m.</p>
                <p ng-message="number" translate>This field must be a number.</p>
              </div>
            </div>

            ## HEIGHT DIFF UP
            <div id="height_diff_up-group" class="half remain form-group"
                 ng-class="{ 'has-feedback': editForm.height_diff_up.$touched,
                             'has-error': editForm.height_diff_up.$touched && editForm.height_diff_up.$invalid,
                             'has-success': outing.height_diff_up }">
              <label ng-class="{ 'control-label': editForm.height_diff_up.$touched && editForm.height_diff_up.$invalid }" translate>height_diff_up</label>
              <div class="input-group">
                <input type="number" min="0" minlength="1" name="height_diff_up" ng-model="outing.height_diff_up" class="form-control" />
                <span class="input-group-addon">m</span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="editForm.height_diff_up.$valid && outing.height_diff_up"></span>
              <span class="glyphicon glyphicon-warning-sign form-control-feedback" ng-show="editForm.height_diff_up.$touched && editForm.height_diff_up.$invalid"></span>
              <div class="help-block" ng-messages="editForm.height_diff_up.$error" ng-if="editForm.height_diff_up.$touched && editForm.height_diff_up.$invalid">
                <p ng-message="number" translate>This field must be a number.</p>
              </div>
            </div>

            ## HEIGHT DIFF DOWN
            <div id="height_diff_down-group" class="half remain form-group"
                 ng-class="{ 'has-feedback': editForm.height_diff_down.$touched,
                             'has-error': editForm.height_diff_down.$touched && editForm.height_diff_down.$invalid,
                             'has-success': outing.height_diff_down }">
              <label ng-class="{ 'control-label': editForm.height_diff_down.$touched && editForm.height_diff_down.$invalid }" translate>height_diff_down</label>
              <div ng-class="{ 'control-label': editForm.height_diff_down.$touched && editForm.height_diff_down.$invalid }" class="input-group">
                <input type="number" min="0" minlength="1" name="height_diff_down" ng-model="outing.height_diff_down" class="form-control" />
                <span class="input-group-addon">m</span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="editForm.height_diff_down.$valid && outing.height_diff_down"></span>
              <span class="glyphicon glyphicon-warning-sign form-control-feedback" ng-show="editForm.height_diff_down.$touched && editForm.height_diff_down.$invalid"></span>
              <div class="help-block" ng-messages="editForm.height_diff_down.$error" ng-if="editForm.height_diff_down.$touched && editForm.height_diff_down.$invalid">
                <p ng-message="number" translate>This field must be a number.</p>
              </div>
            </div>

            ## SKI RATING
            <div class="form-group data half" ng-class="{ 'has-success': outing.ski_rating}"
                 ng-if="outing.activities.indexOf('skitouring') > -1">
              <label c2c-context-help context-help-title="{{'ski_rating' | translate}}" context-help-content-url="/static/partials/contexthelp/route-ski_rating.html"><span translate>ski_rating</label>
              <div class="input-group">
                <select class="form-control" ng-model="outing.ski_rating" ng-options="rat as rat for rat in ${ski_ratings}"><option value=""></option></select>
                <span class="input-group-addon"><span class="glyphicon glyphicon-star"></span></span>
                <span class="input-group-addon" ng-click="editCtrl.openModal('#cotometer-dialog','md')"><span class="glyphicon glyphicon-question-sign"></span></span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-if="outing.ski_rating"></span>
            </div>

            ## LABANDE GLOBAL RATING
            <div class="form-group data half" ng-class="{ 'has-success': outing.labande_global_rating}"
                 ng-if="outing.activities.indexOf('skitouring') > -1">
              <label c2c-context-help context-help-title="{{'labande_global_rating' | translate}}" context-help-content-url="/static/partials/contexthelp/route-labande_global_rating.html"><span translate>labande_global_rating</label>
              <div class="input-group">
                <select class="form-control" ng-model="outing.labande_global_rating" ng-options="rat as rat for rat in ${global_ratings}"><option value=""></option></select>
                <span class="input-group-addon"><span class="glyphicon glyphicon-star"></span></span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-if="outing.labande_global_rating"></span>
            </div>

            ## SNOWSHOE RATING
            <div class="form-group data half" ng-class="{ 'has-success': outing.snowshoe_rating}"
                 ng-if="outing.activities.indexOf('snowshoeing') > -1">
              <label c2c-context-help context-help-title="{{'snowshoe_rating' | translate}}" context-help-content-url="/static/partials/contexthelp/route-snowshoe_rating.html"><span translate>snowshoe_rating</span></label>
              <div class="input-group">
                <select class="form-control" ng-model="outing.snowshoe_rating" ng-options="rat as rat for rat in ${snowshoe_ratings}"><option value=""></option></select>
                <span class="input-group-addon"><span class="glyphicon glyphicon-star"></span></span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-if="outing.snowshoe_rating"></span>
            </div>

            ## GLOBAL RATING
            <div class="form-group data half" ng-class="{ 'has-success': outing.global_rating}"
                 ng-if="outing.activities.indexOf('snow_ice_mixed') > -1
                     || outing.activities.indexOf('mountain_climbing') > -1
                     || outing.activities.indexOf('rock_climbing') > -1">
              <label c2c-context-help context-help-title="{{'global_rating' | translate}}" context-help-content-url="/static/partials/contexthelp/route-global_rating.html"><span translate>global_rating</span></label>
              <div class="input-group">
                <select class="form-control" ng-model="outing.global_rating" ng-options="rat as rat for rat in ${global_ratings}"><option value=""></option></select>
                <span class="input-group-addon"><span class="glyphicon glyphicon-star"></span></span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-if="outing.global_rating"></span>
            </div>

            ## ENGAGEMENT RATING
            <div class="form-group data half" ng-class="{ 'has-success': outing.engagement_rating}"
                 ng-if="outing.activities.indexOf('snow_ice_mixed') > -1
                     || outing.activities.indexOf('mountain_climbing') > -1">
              <label c2c-context-help context-help-title="{{'engagement_rating' | translate}}" context-help-content-url="/static/partials/contexthelp/route-engagement_rating.html"><span translate>engagement_rating</span></label>
              <div class="input-group">
                <select class="form-control" ng-model="outing.engagement_rating" ng-options="rat as rat for rat in ${engagement_ratings}"><option value=""></option></select>
                <span class="input-group-addon"><span class="glyphicon glyphicon-star"></span></span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-if="outing.engagement_rating"></span>
            </div>

            ## EQUIPMENT RATING
            <div class="form-group data half" ng-class="{ 'has-success': outing.equipment_rating}"
                 ng-if="outing.activities.indexOf('rock_climbing') > -1">
              <label c2c-context-help context-help-title="{{'equipment_rating' | translate}}" context-help-content-url="/static/partials/contexthelp/route-equipment_rating.html"><span translate>equipment_rating</span></label>
              <div class="input-group">
                <select class="form-control" ng-model="outing.equipment_rating" ng-options="rat as rat for rat in ${equipment_ratings}"><option value=""></option></select>
                <span class="input-group-addon"><span class="glyphicon glyphicon-star"></span></span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-if="outing.equipment_rating"></span>
            </div>

            ## ICE RATING
            <div class="form-group data half" ng-class="{ 'has-success': outing.ice_rating}"
                 ng-if="outing.activities.indexOf('ice_climbing') > -1">
              <label c2c-context-help context-help-title="{{'ice_rating' | translate}}" context-help-content-url="/static/partials/contexthelp/route-ice_rating.html"><span translate>ice_rating</span></label>
              <div class="input-group">
                <select class="form-control" ng-model="outing.ice_rating" ng-options="rat as rat for rat in ${ice_ratings}"><option value=""></option></select>
                <span class="input-group-addon"><span class="glyphicon glyphicon-star"></span></span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-if="outing.ice_rating"></span>
            </div>

            ## VIA FERRATA RATING
            <div class="form-group data half" ng-class="{ 'has-success': outing.via_ferrata_rating}"
                 ng-if="outing.activities.indexOf('via_ferrata') > -1">
                            <label c2c-context-help context-help-title="{{'via_ferrata_rating' | translate}}" context-help-content-url="/static/partials/contexthelp/route-via_ferrata_rating.html"><span translate>via_ferrata_rating</span></label>
              <div class="input-group">
                <select class="form-control" ng-model="outing.via_ferrata_rating" ng-options="rat as rat for rat in ${via_ferrata_ratings}"><option value=""></option></select>
                <span class="input-group-addon"><span class="glyphicon glyphicon-star"></span></span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-if="outing.via_ferrata_rating"></span>
            </div>

            ## HIKING RATING
            <div class="form-group data half" ng-class="{ 'has-success': outing.hiking_rating}"
                 ng-if="outing.activities.indexOf('hiking') > -1">
              <label c2c-context-help context-help-title="{{'hiking_rating' | translate}}" context-help-content-url="/static/partials/contexthelp/route-hiking_rating.html"><span translate>hiking_rating</span></label>
              <div class="input-group">
                <select class="form-control" ng-model="outing.hiking_rating" ng-options="rat as rat for rat in ${hiking_ratings}"><option value=""></option></select>
                <span class="input-group-addon"><span class="glyphicon glyphicon-star"></span></span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-if="outing.hiking_rating"></span>
            </div>

            ## MTB DOWN RATING
            <div class="form-group data half" ng-class="{ 'has-success': outing.mtb_down_rating}"
                 ng-if="outing.activities.indexOf('mountain_biking') > -1">
              <label c2c-context-help context-help-title="{{'mtb_down_rating' | translate}}" context-help-content-url="/static/partials/contexthelp/route-mtb_down_rating.html"><span translate>mtb_down_rating</span></label>
              <div class="input-group">
                <select class="form-control" ng-model="outing.mtb_down_rating" ng-options="rat as rat for rat in ${mtb_down_ratings}"><option value=""></option></select>
                <span class="input-group-addon"><span class="glyphicon glyphicon-star"></span></span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-if="outing.mtb_down_rating"></span>
            </div>

            ## MTB UP RATING
            <div class="form-group data half" ng-class="{ 'has-success': outing.mtb_up_rating}"
                 ng-if="outing.activities.indexOf('mountain_biking') > -1">
              <label c2c-context-help context-help-title="{{'mtb_up_rating' | translate}}" context-help-content-url="/static/partials/contexthelp/route-mtb_up_rating.html"><span translate>mtb_up_rating</span></label>
              <div class="input-group">
                <select class="form-control" ng-model="outing.mtb_up_rating" ng-options="rat as rat for rat in ${mtb_up_ratings}"><option value=""></option></select>
                <span class="input-group-addon"><span class="glyphicon glyphicon-star"></span></span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-if="outing.mtb_up_rating"></span>
            </div>

            ## ROCK FREE RATING
            <div class="form-group data half" ng-class="{ 'has-success': outing.rock_free_rating}"
                 ng-if="outing.activities.indexOf('rock_climbing') > -1">
              <label c2c-context-help context-help-title="{{'rock_free_rating' | translate}}" context-help-content-url="/static/partials/contexthelp/route-rock_free_rating.html"><span translate>rock_free_rating</span></label>
              <div class="input-group">
                <select class="form-control" ng-model="outing.rock_free_rating" ng-options="rat as rat for rat in ${climbing_ratings}"><option value=""></option></select>
                <span class="input-group-addon"><span class="glyphicon glyphicon-star"></span></span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-if="outing.rock_free_rating"></span>
            </div>

            ## HEIGHT DIFF DIFFICULTIES
            <div id="height_diff_difficulties-group" class="data half form-group"
                 ng-if="outing.activities.indexOf('snow_ice_mixed') > -1 || outing.activities.indexOf('mountain_climbing') > -1"
                 ng-class="{ 'has-feedback': editForm.height_diff_difficulties.$touched,
                             'has-error': editForm.height_diff_difficulties.$touched && editForm.height_diff_difficulties.$invalid,
                             'has-success': outing.height_diff_difficulties }">
              <label ng-class="{ 'control-label': editForm.height_diff_difficulties.$touched && editForm.height_diff_difficulties.$invalid }" c2c-context-help context-help-title="{{'height_diff_difficulties' | translate}}" context-help-content="{{'Combined elevation of the main difficulties of a route, for a route where approach is distinguished from the route itself. Do not mix up with the difficulties length: difficulties height is always lower.' | translate}}"><span translate>height_diff_difficulties</span></label>
              <div class="input-group">
                <input type="number" min="0" name="height_diff_difficulties" ng-model="outing.height_diff_difficulties" class="form-control" />
                <span class="input-group-addon">m</span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-if="outing.height_diff_difficulties"></span>
              <span class="glyphicon glyphicon-warning-sign form-control-feedback" ng-if="editForm.height_diff_difficulties.$invalid && editForm.height_diff_difficulties.$touched"></span>
              <div class="help-block" ng-messages="editForm.height_diff_difficulties.$error" ng-if="editForm.height_diff_difficulties.$touched && editForm.height_diff_difficulties.$invalid">
                <p ng-message="number" translate>This field must be a number.</p>
              </div>
            </div>

          </div>
        </section>
      </div>

      <div class="step step-2">
        <section class="section conditions">
          <h2 class="heading show-phone"><span><span translate>weather</span> & <span translate>conditions</span></span></h2>
          <div class="content collapse in" id="outing-conditions">

            ## WEATHER
            <div class="full form-group">
              <label translate>weather</label>
              <textarea app-markdown-editor class="form-control" ng-model="outing.locales[0]['weather']" placeholder="{{'describe weather' | translate}}"></textarea>
            </div>

            ## CONDITIONS LEVELS
            <div class="full form-group"
                 ng-if="outing.activities.indexOf('skitouring') > -1 || outing.activities.indexOf('snowshoeing') > -1 || outing.activities.indexOf('ice_climbing') > -1 || outing.activities.indexOf('snow_ice_mixed') > -1 ">
               <label c2c-context-help context-help-title="{{'conditions_levels' | translate}}" context-help-content-url="/static/partials/contexthelp/outing-conditions_levels.html"><span translate>conditions_levels</span></label>
              <table class="table table-striped conditions-levels" ng-if="outing.locales[0].conditions_levels[0]">
                <thead>
                  <tr>
                    <th class="location"><span translate>location</span> / <span translate>elevation</span> / <span translate>orientations</span></th>
                    <th class="soft-snow"><span translate>soft snow</span> (cm)</th>
                    <th class="total-snow"><span translate>total snow</span> (cm)</th>
                    <th class="comment" translate>comment</th>
                    <th class="delete"></th>
                  </tr>
                </thead>
                <tbody>
                  <tr ng-repeat="cond in outing.locales[0].conditions_levels">
                    <td><input type="text" class="form-control" ng-model="outing.locales[0].conditions_levels[$index].level_place"></td>
                    <td><input type="text" class="form-control" ng-model="outing.locales[0].conditions_levels[$index].level_snow_height_soft"></td>
                    <td><input type="text" class="form-control" ng-model="outing.locales[0].conditions_levels[$index].level_snow_height_total"></td>
                    <td><input type="text" class="form-control" ng-model="outing.locales[0].conditions_levels[$index].level_comment"></td>
                    <td ng-click="outing.locales[0].conditions_levels.splice($index, 1)"><span class="glyphicon glyphicon-trash"></span></td>
                  </tr>
                </tbody>
              </table>
              <button class="btn orange-btn" type="button" ng-click="outing.locales[0].conditions_levels.push({})" translate>add row</button>
            </div>

            ## CONDITIONS
            <div class=" full form-group">
              <label translate>conditions</label>
              <textarea app-markdown-editor class="form-control" ng-model="outing.locales[0]['conditions']" placeholder="{{'describe conditions' |Â translate}}"></textarea>
            </div>

            ## CONDITION RATING
            <div class="form-group half" ng-class="{'has-success': outing.condition_rating}" ng-init="condition_ratings = ${condition_ratings}">
              <label c2c-context-help context-help-title="{{'condition_rating' | translate}}" context-help-content="{{'Global judgment on the conditions encountered on the route during the outing. This criterion can be used to filter outings. The <i>Conditions</i> field allows to fill in additional information.' | translate}}"><span translate>condition_rating</span></label>
              <div class="input-group">
                <select class="form-control" ng-model="outing.condition_rating" ng-options="rat as mainCtrl.translate(rat) for rat in condition_ratings"><option value=""></option></select>
                <span class="input-group-addon"><span class="glyphicon glyphicon-star"></span></span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="outing.condition_rating"></span>
            </div>

            ## ELEVATION UP SNOW
            <div id="elevation_up_snow-group" class="half form-group"
                 ng-class="{ 'has-feedback': editForm.elevation_up_snow.$touched,
                             'has-error': editForm.elevation_up_snow.$touched && editForm.elevation_up_snow.$invalid,
                             'has-success': outing.elevation_up_snow }"
                 ng-if="outing.activities.indexOf('skitouring') > -1 || outing.activities.indexOf('snowshoeing') > -1 || outing.activities.indexOf('ice_climbing') > -1  || outing.activities.indexOf('mountain_climbing') > -1  || outing.activities.indexOf('snow_ice_mixed') > -1">
              <label ng-class="{ 'control-label': editForm.elevation_up_snow.$touched && editForm.elevation_up_snow.$invalid }" c2c-context-help context-help-title="{{'elevation_up_snow' | translate}}" context-help-content="{{'Elevation at which skis were put on, on the way up. The <i>Conditions</i> field allows to fill in additional information.' | translate}}"><span translate>elevation_up_snow</span></label>
              <div class="input-group">
                <input type="number" min="0" max="9999" minlength="1" name="elevation_up_snow" ng-model="outing.elevation_up_snow" class="form-control" />
                <span class="input-group-addon">m</span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="editForm.elevation_up_snow.$valid && outing.elevation_up_snow"></span>
              <span class="glyphicon glyphicon-warning-sign form-control-feedback" ng-show="editForm.elevation_up_snow.$touched && editForm.elevation_up_snow.$invalid"></span>
              <div class="help-block" ng-messages="editForm.elevation_up_snow.$error" ng-if="editForm.elevation_up_snow.$touched && editForm.elevation_up_snow.$invalid">
                <p ng-message="max" translate>This field must be lower than 9999 m.</p>
                <p ng-message="number" translate>This field must be a number.</p>
              </div>
            </div>

            ## ELEVATION DOWN SNOW
            <div id="elevation_down_snow-group" class="half form-group"
                 ng-class="{ 'has-feedback': editForm.elevation_down_snow.$touched,
                             'has-error': editForm.elevation_down_snow.$touched && editForm.elevation_down_snow.$invalid,
                             'has-success': outing.elevation_down_snow }"
                 ng-if="outing.activities.indexOf('snow_ice_mixed') > -1 || outing.activities.indexOf('mountain_climbing') > -1 || outing.activities.indexOf('ice_climbing') > -1  || outing.activities.indexOf('snowshoeing') > -1 || outing.activities.indexOf('skitouring') > -1">
              <label ng-class="{ 'control-label': editForm.elevation_down_snow.$touched && editForm.elevation_down_snow.$invalid }" c2c-context-help context-help-title="{{'elevation_down_snow' | translate}}" context-help-content="{{'Elevation at which skis were taken off, on the way down. The <i>Conditions</i> field allows to fill in additional information.' | translate}}"><span translate>elevation_down_snow</span></label>
              <div class="input-group">
                <input type="number" min="0" max="9999" minlength="1" name="elevation_down_snow" ng-model="outing.elevation_down_snow" class="form-control" />
                <span class="input-group-addon">m</span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="editForm.elevation_down_snow.$valid && outing.elevation_down_snow"></span>
              <span class="glyphicon glyphicon-warning-sign form-control-feedback" ng-show="editForm.elevation_down_snow.$touched && editForm.elevation_down_snow.$invalid"></span>
              <div class="help-block" ng-messages="editForm.elevation_down_snow.$error" ng-if="editForm.elevation_down_snow.$touched && editForm.elevation_down_snow.$invalid">
                <p ng-message="max" translate>This field must be lower than 9999m.</p>
                <p ng-message="number" translate>This field must be a number.</p>
              </div>
            </div>

              ## SNOW QUANTITY
            <div id="snow_quantity-group" class="half form-group" ng-class="{ 'has-error': editForm.snow_quantity.$touched && editForm.snow_quantity.$invalid,'has-success': outing.snow_quantity }"
                 ng-if="outing.activities.indexOf('skitouring') > -1 || outing.activities.indexOf('snowshoeing') > -1 || outing.activities.indexOf('ice_climbing') > -1  || outing.activities.indexOf('mountain_climbing') > -1  || outing.activities.indexOf('snow_ice_mixed') > -1 ">
              <label translate>snow_quantity</label>
              <select class="form-control" ng-model="outing.snow_quantity" ng-options="rat as mainCtrl.translate(rat) for rat in ${condition_ratings}"><option value=""></option></select>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="outing.snow_quantity"></span>
            </div>

            ## SNOW QUALITY
            <div id="snow_quality-group" class="half form-group" ng-class="{ 'has-error': editForm.snow_quality.$touched && editForm.snow_quality.$invalid,'has-success': outing.snow_quality }"
                 ng-if="outing.activities.indexOf('skitouring') > -1 || outing.activities.indexOf('snowshoeing') > -1 || outing.activities.indexOf('ice_climbing') > -1  || outing.activities.indexOf('mountain_climbing') > -1  || outing.activities.indexOf('snow_ice_mixed') > -1">
              <label translate>snow_quality</label>
              <select class="form-control" ng-model="outing.snow_quality" ng-options="rat as mainCtrl.translate(rat) for rat in ${condition_ratings}"><option value=""></option></select>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="outing.snow_quality"></span>
            </div>

            ## GLACIER RATING
            <div class="form-group half" ng-if="outing.activities.indexOf('skitouring') > -1 || outing.activities.indexOf('snowshoeing') > -1 || outing.activities.indexOf('mountain_climbing') > -1  || outing.activities.indexOf('snow_ice_mixed') > -1 ">
              <label c2c-context-help context-help-title="{{'glacier_rating' | translate}}" context-help-content="{{'Condition of the glacier followed by the route: covered and easy to cross, delicate but travel is possible, open and difficult to cross or clearly imposible to cross. The <i>Conditions</i> field allows to fill in additional information.' | translate}}"><span translate>glacier_rating</span></label>
              <div class="input-group" ng-class="{'has-success': outing.glacier_rating }">
                <select class="form-control" ng-model="outing.glacier_rating" ng-options="rat as mainCtrl.translate(rat) for rat in ${glacier_ratings}"><option value=""></option></select>
                <span class="input-group-addon"><span class="glyphicon glyphicon-star"></span></span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="outing.glacier_rating"></span>
            </div>

            ## AVALANCHE SIGNS
            <div class="form-group full" ng-init="signs = ${avalanche_signs}; outing.avalanche_signs = outing.avalanche_signs || [];"
                  ng-if="outing.activities.indexOf('skitouring') > -1 || outing.activities.indexOf('snowshoeing') > -1 || outing.activities.indexOf('ice_climbing') > -1 || outing.activities.indexOf('snow_ice_mixed') > -1">
              <label translate>avalanche_signs</label>
              <ul class="types">
                <li ng-click="outing.avalanche_signs.indexOf('no') == -1 ? (outing.avalanche_signs = ['no']) : (outing.avalanche_signs[outing.avalanche_signs.indexOf('no')] = null)">
                  <div class="checkbox"><input type="checkbox" ng-checked="outing.avalanche_signs.indexOf('no') > -1"><span translate>no</span></div>
                </li>
                ## don't show other options if 'no' is selected
                <li ng-repeat="type in signs" ng-click="editCtrl.pushToArray(outing, 'avalanche_signs', type, $event)" ng-if="$index > 0 && outing.avalanche_signs.indexOf('no') == -1">
                  <div class="checkbox"><input type="checkbox" ng-checked="outing.avalanche_signs.indexOf(type) > -1"><span>{{type | translate}}</span></div>
                </li>
              </ul>
            </div>

            ## AVALANCHES
            <div class="form-group  full"  ng-if="(outing.activities.indexOf('skitouring') > -1 || outing.activities.indexOf('snowshoeing') > -1
                      || outing.activities.indexOf('ice_climbing') > -1 || outing.activities.indexOf('snow_ice_mixed') > -1) && (outing.avalanche_signs != 'no' && outing.avalanche_signs != null) ">
              <label c2c-context-help context-help-title="{{'conditions_levels' | translate}}" context-help-content-url="/static/partials/contexthelp/outing-avalanche_signs.html"><span translate>avalanches</span></label>
              <textarea app-markdown-editor class="form-control" ng-model="outing.locales[0]['avalanches']"></textarea>
            </div>

          </div>
        </section>

        <section class="section access">
          <h2 class="heading show-phone">
            <span><span translate>access</span> & <span translate>hut</span></span>
          </h2>

          <div class="content outing-route" id="track-edit">

            ## PUBLIC TRANSPORT
            <div class="form-group half" ng-class="{'has-success': outing.public_transport != undefined}">
              <label translate>public_transport</label>
              <input type="checkbox" ng-model="outing.public_transport">
              <span ng-click="editCtrl.pushToArray(outing, 'public_transport', !outing.public_transport, $event)"></span>
              <a href="http://changerdapproche.org/le-concours/presentation.html" target="_blank" ng-if="outing.public_transport" translate>Participate to MW contest</a>
            </div>

            ## FREQUENTATION
            <div class="form-group half" ng-class="{'has-success': outing.frequentation}" ng-init="frequentation_types = ${frequentation_types}">
              <label c2c-context-help context-help-title="{{'frequentation' | translate}}" context-help-content-url="/static/partials/contexthelp/outing-frequentation.html"><span translate>frequentation</span></label>
              <select class="form-control" ng-model="outing.frequentation" ng-options="rat as mainCtrl.translate(rat) for rat in frequentation_types"><option value=""></option></select>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="outing.frequentation"></span>
            </div>

            ## LIFT STATUS
            <div class="form-group half" ng-class="{'has-success': outing.lift_status}" ng-init="lift_status = ${lift_status}">
              <label translate>lift_status</label>
              <div class="input-group">
                <select class="form-control" ng-model="outing.lift_status" ng-options="rat as mainCtrl.translate(rat) for rat in lift_status"><option value=""></option></select>
                <span class="input-group-addon"><span class="glyphicon glyphicon-resize-vertical"></span></span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="outing.lift_status"></span>
            </div>

            ## HUT COMMENT
            <div class="form-group  full" ng-class="{'has-success': outing.locales[0].hut_comment}">
              <label translate>hut_comment</label>
              <textarea app-markdown-editor class="form-control " ng-model="outing.locales[0].hut_comment"></textarea>
            </div>

            ## HUT STATUS
            <div class="form-group half" ng-class="{'has-success': outing.hut_status}" ng-init="hut_status = ${hut_status}">
              <label translate>hut_status</label>
              <div class="input-group">
                <select class="form-control" ng-model="outing.hut_status" ng-options="rat as mainCtrl.translate(rat) for rat in hut_status"><option value=""></option></select>
                <span class="input-group-addon"><span class="glyphicon glyphicon-home"></span></span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="outing.hut_status"></span>
            </div>

            ## ELEVATION ACCESS
            <div id="elevation_access-group" class="half form-group"
                 ng-class="{ 'has-feedback': editForm.elevation_access.$touched,
                             'has-error': editForm.elevation_access.$touched && editForm.elevation_access.$invalid,'has-success': outing.elevation_access }">
              <label ng-class="{ 'control-label': editForm.elevation_access.$touched && editForm.elevation_access.$invalid }" translate>elevation_access</label>
              <div class="input-group">
                <input type="number" min="0" max="9999" minlength="1" name="elevation_access" ng-model="outing.elevation_access" class="form-control" />
                <span class="input-group-addon">m</span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="editForm.elevation_access.$valid && outing.elevation_access"></span>
              <span class="glyphicon glyphicon-warning-sign form-control-feedback" ng-show="editForm.elevation_access.$touched && editForm.elevation_access.$invalid"></span>
              <div class="help-block" ng-messages="editForm.elevation_access.$error" ng-if="editForm.elevation_access.$touched && editForm.elevation_access.$invalid">
                <p ng-message="max" translate>This field must be lower than 9999 m.</p>
                <p ng-message="number" translate>This field must be a number.</p>
              </div>
            </div>

            ## ACCESS CONDITION
            <div class="form-group half"  ng-class="{'has-success': outing.access_condition}" ng-init="access_conditions = ${access_conditions}">
              <label translate>access_condition</label>
              <div class="input-group">
                <select class="form-control" ng-model="outing.access_condition" ng-options="rat as mainCtrl.translate(rat) for rat in access_conditions"><option value=""></option></select>
                <span class="input-group-addon"><span class="glyphicon glyphicon-road"></span></span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="outing.access_condition"></span>
            </div>

            ## ACCESS COMMENT
            <div class="form-group data full" ng-class="{'has-success': outing.locales[0].access_comment}">
              <label translate>access_comment</label>
              <textarea app-markdown-editor class="form-control " ng-model="outing.locales[0].access_comment"></textarea>
            </div>

          </div>
        </section>

      </div>

      <div class="step step-3">
        <section class="section">
          <h2 class="heading show-phone"><span translate>Comments</span></h2>
          <div class="content collapse in">

            ## TITLE
            <div class="form-group" id="title-group"
                 ng-class="{ 'has-feedback': editForm.title.$touched,
                             'has-error': editForm.title.$touched && editForm.title.$invalid,
                             'has-success': editForm.title.$valid }">
              <label ng-class="{ 'control-label': editForm.title.$touched && editForm.title.$invalid }"><span translate>outing title</span> *</label>
              <input type="text" name="title" ng-model="outing.locales[0].title" ng-minlength="3" class="form-control" required/>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="editForm.title.$valid && outing.title"></span>
              <span class="glyphicon glyphicon-warning-sign form-control-feedback" ng-show="editForm.title.$touched && editForm.title.$invalid"></span>
              <div class="help-block" ng-messages="editForm.title.$error" ng-if="editForm.title.$touched && editForm.title.$invalid">
                <p ng-message="required" translate>This field is required.</p>
                <p ng-message="minlength" translate>Title must have at least 3 characters.</p>
              </div>
            </div>

            ## LANGUAGE
            <div id="lang-group" class="form-group"
                 ng-class="{ 'has-feedback': editForm.lang.$touched,
                             'has-error': editForm.lang.$touched && editForm.lang.$invalid,
                             'has-success': editForm.lang.$valid}">
              <label ng-class="{ 'control-label': editForm.lang.$touched && editForm.lang.$invalid }"><span translate>lang</span> *</label>
              % if outing_lang:
                <input disabled class="form-control" value="{{mainCtrl.translate('${outing_lang}')}}">
                <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="editForm.lang.$valid && outing.lang"></span>
                <span class="glyphicon glyphicon-warning-sign form-control-feedback" ng-show="editForm.lang.$invalid && outing.lang"></span>
              % else:
                <select name="lang" ng-options="lang as mainCtrl.translate(lang) for lang in ['${"','".join(default_langs) |n}'] | translate" ng-model="outing.locales[0].lang" class="form-control" required><option value=""></option></select>
              % endif
              <div class="help-block" ng-messages="editForm.lang.$error" ng-if="editForm.lang.$touched && editForm.lang.$invalid">
                <p ng-message="required" translate>This field is required.</p>
              </div>
            </div>

            ## ASSOCIATED PARTICIPANTS
            ## TODO better to show all users in one row, will have to convert users in controller.
            <div id="participants-group" class="form-group  full" ng-class="{'has-success': outing.locales[0]['participants']}">
              <label c2c-context-help context-help-title="{{'associated_participants' | translate}}" context-help-content="{{'Registered participants can be directly associated to the outing, thus allowing them to modify the outing, add pictures, and associate other registered participants.' |translate}}"><span translate>associated_participants</span></label>

              <section class="section associations">
                <app-simple-search parent-id="outing.document_id"
                                   app-select="editCtrl.documentService.pushToAssociations(doc, 'users')" dataset="u"></app-simple-search>
                <section class="associated-section flex wrap-row">
                  <h5 translate ng-if="outing.associations.users.length == 0">You can look up for users that were with you during the outing.</h5>
                  <div class="list users" ng-if="outing.associations.users.length > 0">
                    <div class="list-item users new-item" ng-repeat="user in outing.associations.users track by user.name">
                      <c2c-card c2c-card-doc="{'document_id': user.document_id, 'name': user.name, 'type': 'u', 'locales': user.locales}"></c2c-card>
                      <span class="glyphicon glyphicon-trash"
                            ng-click="editCtrl.documentService.removeAssociation(user.document_id, 'users', $event)"
                            ng-if="outing.associations.users.length > 1"></span>
                    </div>
                  </div>
                </section>

              </section>
            </div>

            ## PARTICIPANTS
            <div id="participants-group" class="form-group full" ng-class="{'has-success': outing.locales[0]['participants']}">
              <label c2c-context-help context-help-title="{{'participants' | translate}}" context-help-content="{{'List of participants to the outing who are not registered users on the website.' |translate}}"><span translate>participants</span></label>
              <div class="input-group">
                <input type="text"  ng-model="outing.locales[0]['participants']" class="form-control" />
                <span class="input-group-addon"><span class="glyphicon glyphicon-user"></span></span>
              </div>
            </div>

            ## NUMBER OF PARTICIPANTS
            <div id="participants-group" class="form-group half"
                 ng-class="{ 'has-feedback': editForm.participant_count.$touched,
                             'has-success': outing.participant_count,
                             'has-error': editForm.participant_count.$touched && editForm.participant_count.$invalid }">
              <label ng-class="{ 'control-label': editForm.participant_count.$touched && editForm.particpant_count.$invalid }" translate>participant_count</label>
              <div class="input-group">
                <input type="number" min="1" max="9999" name="participant_count" ng-model="outing.participant_count" class="form-control" />
                <span class="input-group-addon"><span class="glyphicon glyphicon-user"></span></span>
              </div>
              <span class="glyphicon glyphicon-ok form-control-feedback" ng-show="editForm.participant_count.$valid && outing.participant_count"></span>
              <span class="glyphicon glyphicon-warning-sign form-control-feedback" ng-show="editForm.participant_count.$touched && editForm.participant_count.$invalid"></span>
              <div class="help-block" ng-messages="editForm.participant_count.$error" ng-if="editForm.participant_count.$touched && editForm.participant_count.$invalid">
                <p ng-message="max" translate>This field must be lower than 9999.</p>
                <p ng-message="number" translate>This field must be a number.</p>
              </div>
            </div>

            ## COMMENT
            <div class="full form-group">
              <label translate>personal comments</label>
              <textarea app-markdown-editor class="form-control description" placeholder="{{'write your comments' | translate}}" ng-model="outing.locales[0]['description']"></textarea>
            </div>

            ## COMMENTS MANAGEMENT
            <div class="form-group full">
              <label translate>disable_comments</label>
              <input type="checkbox" ng-model="outing.disable_comments">
              <span ng-click="editCtrl.pushToArray(outing, 'disable_comments', !outing.disable_comments, $event)" translate>If checked, comments cannot be posted or read.</span>
            </div>

          </div>
        </section>
      </div>
      <div class="clear"></div>
      ${show_editing_buttons('outing', updating_doc, outing_id, outing_lang)}

    </section>
  </form>
  ${show_preview_container()}
  ${show_save_confirmation_modal(updating_doc)}
  ${show_cotometer_dialog('outings', lang, other_langs)}
</section>
</div>